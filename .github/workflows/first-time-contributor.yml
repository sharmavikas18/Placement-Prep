name: Welcome First-Time Contributors

on:
  pull_request:
    types: [opened]

jobs:
  welcome-contributor:
    runs-on: ubuntu-latest

    permissions:
      pull-requests: write
      issues: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Check if First-Time Contributor
        uses: actions/github-script@v7
        id: check-first-time
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const author = pr.user.login;

            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              per_page: 100
            });

            const userPRs = prs.data.filter(p => p.user.login === author);
            const isFirstTime = userPRs.length === 1;

            core.setOutput('is-first-time', isFirstTime);
            core.setOutput('author', author);
            core.setOutput('pr-number', pr.number);

      - name: Welcome First-Time Contributor
        if: steps.check-first-time.outputs.is-first-time == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const author = '${{ steps.check-first-time.outputs.author }}';
            const prNumber = Number('${{ steps.check-first-time.outputs.pr-number }}');

            const welcomeMessage = `
## ğŸ‰ Welcome to Placement-Prep, @${author}!

### ğŸŒŸ First-Time Contributor Badge
![First Time Contributor](https://img.shields.io/badge/First%20Time%20Contributor-Placement--Prep-brightgreen?style=for-the-badge&logo=github)

ğŸŠ **Congratulations!** This is your first contribution to our open-source project.

### ğŸ¯ What Happens Next
- Maintainers will review your PR
- You may receive suggestions
- Once approved, your PR will be merged ğŸš€

### ğŸ’¡ Tips
- Respond to review comments
- Keep commits clean
- Ask questions if stuck

### ğŸ† Recognition
- Added to contributors list
- Eligible for open-source programs (GSSoC / ECWoC)

---
*Welcome to the community! ğŸŒŸ*
            `;

            await github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: welcomeMessage
            });

      - name: Add First-Time Contributor Label
        if: steps.check-first-time.outputs.is-first-time == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = Number('${{ steps.check-first-time.outputs.pr-number }}');

            await github.rest.issues.addLabels({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['first-time-contributor']
            });
