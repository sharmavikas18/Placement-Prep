name: üîÅ Duplicate Issue Detector

on:
  issues:
    types: [opened]

permissions:
  issues: write

jobs:
  detect-duplicate:
    runs-on: ubuntu-latest

    steps:
      - name: Check for Duplicate Issues
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const newIssue = context.payload.issue;
            const newTitle = newIssue.title.toLowerCase();
            const newBody = (newIssue.body || '').toLowerCase();

            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 50
            });

            for (const issue of issues.data) {
              if (issue.number === newIssue.number) continue;

              const oldTitle = issue.title.toLowerCase();
              const oldBody = (issue.body || '').toLowerCase();

              // simple similarity check
              if (
                oldTitle.includes(newTitle) ||
                newTitle.includes(oldTitle) ||
                (newBody && oldBody && oldBody.includes(newBody))
              ) {
                const comment = [
                  `## üîÅ Possible Duplicate Issue Detected`,
                  ``,
                  `Hi @${newIssue.user.login},`,
                  ``,
                  `This issue looks similar to an existing issue:`,
                  `üëâ **#${issue.number} ‚Äì ${issue.title}**`,
                  ``,
                  `### ‚úÖ What to do next`,
                  `- If this is the same problem, please continue the discussion there.`,
                  `- If different, kindly explain how this issue is unique.`,
                  ``,
                  `Thanks for helping keep Placement-Prep organized! üôå`,
                  ``,
                  `---`,
                  `*Automated duplicate detection*`
                ].join('\n');

                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: newIssue.number,
                  body: comment
                });

                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: newIssue.number,
                  labels: ['possible-duplicate']
                });

                break;
              }
            }
